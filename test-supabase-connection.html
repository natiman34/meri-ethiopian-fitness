<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Supabase Connection Test</h1>
    
    <div class="test-section info">
        <h2>Test Configuration</h2>
        <p><strong>Local Supabase URL:</strong> http://127.0.0.1:54321</p>
        <p>This test will verify that the Supabase connection is working and the user_activity_progress table is accessible.</p>
    </div>

    <div class="test-section">
        <h2>Connection Tests</h2>
        <button onclick="testConnection()">Test Basic Connection</button>
        <button onclick="testTableAccess()">Test Table Access</button>
        <button onclick="testInsert()">Test Insert Operation</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        // Initialize Supabase client with local development settings
        const supabaseUrl = 'http://127.0.0.1:54321'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        function log(message) {
            const logElement = document.getElementById('testLog')
            const timestamp = new Date().toLocaleTimeString()
            logElement.textContent += `[${timestamp}] ${message}\n`
            logElement.scrollTop = logElement.scrollHeight
        }

        function clearLogs() {
            document.getElementById('testLog').textContent = ''
        }

        async function testConnection() {
            log('üß™ Testing basic Supabase connection...')
            
            try {
                // Test basic connection by trying to access the health endpoint
                const response = await fetch(`${supabaseUrl}/rest/v1/`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                })
                
                if (response.ok) {
                    log('‚úÖ SUCCESS: Basic connection to Supabase is working')
                } else {
                    log(`‚ùå ERROR: Connection failed with status ${response.status}`)
                }
            } catch (error) {
                log(`‚ùå ERROR: Connection failed - ${error.message}`)
            }
        }

        async function testTableAccess() {
            log('üß™ Testing user_activity_progress table access...')
            
            try {
                const { data, error } = await supabase
                    .from('user_activity_progress')
                    .select('*')
                    .limit(1)

                if (error) {
                    log(`‚ùå ERROR: Table access failed - ${error.message}`)
                    log(`   Error details: ${JSON.stringify(error, null, 2)}`)
                } else {
                    log('‚úÖ SUCCESS: user_activity_progress table is accessible')
                    log(`   Found ${data.length} records`)
                }
            } catch (error) {
                log(`‚ùå ERROR: Table access exception - ${error.message}`)
            }
        }

        async function testInsert() {
            log('üß™ Testing insert operation...')
            
            // First, let's try to sign up a test user
            const testEmail = 'test-' + Date.now() + '@example.com'
            const testPassword = 'TestPassword123!'
            
            try {
                log(`   Creating test user: ${testEmail}`)
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword,
                    options: {
                        data: {
                            full_name: 'Test User',
                            role: 'user'
                        }
                    }
                })

                if (authError) {
                    log(`‚ùå ERROR: User creation failed - ${authError.message}`)
                    return
                }

                if (!authData.user) {
                    log('‚ùå ERROR: No user data returned from signup')
                    return
                }

                log(`‚úÖ SUCCESS: Test user created with ID: ${authData.user.id}`)

                // Now test inserting activity progress
                log('   Testing activity progress insert...')
                const { data, error } = await supabase
                    .from('user_activity_progress')
                    .upsert({
                        user_id: authData.user.id,
                        selected_dates: ['2024-01-15', '2024-01-16']
                    }, {
                        onConflict: 'user_id'
                    })
                    .select()

                if (error) {
                    log(`‚ùå ERROR: Insert failed - ${error.message}`)
                    log(`   Error details: ${JSON.stringify(error, null, 2)}`)
                } else {
                    log('‚úÖ SUCCESS: Activity progress insert worked!')
                    log(`   Inserted data: ${JSON.stringify(data, null, 2)}`)
                }

            } catch (error) {
                log(`‚ùå ERROR: Insert test exception - ${error.message}`)
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Supabase connection test page loaded')
            log('üì° Supabase client initialized')
            log(`üîó Connected to: ${supabaseUrl}`)
            log('üîë Using local development anon key')
        })
    </script>
</body>
</html>
